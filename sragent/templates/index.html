<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Editor</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/stylesheet.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.datatables.net/v/dt/dt-2.1.7/fh-4.0.1/r-3.0.3/sc-2.4.3/sb-1.8.0/sp-2.3.2/datatables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/v/dt/dt-2.1.7/fh-4.0.1/r-3.0.3/sc-2.4.3/sb-1.8.0/sp-2.3.2/datatables.min.js"></script>
    <script src="https://cdn.datatables.net/plug-ins/2.1.7/features/scrollResize/dataTables.scrollResize.min.js"></script>
</head>
<body>
         <div class="top-row">  
            <p>
            The is a test of the top row div. <br>
            This is where navigation and info will go. <br>
            <br>
            <a href="#" id="toggle-readme">README</a>  <!-- Toggle Link -->
            </p>
         </div>
    <div class="container">
        <!-- Left Column -->

        <div class="column-left">
                <br>
                <br>
                <input type="text" id="project_id" placeholder="Enter Project ID"\>
                <button id="gather-button">Run gather()</button>
            <br>
            <br>
            <h4> Summary Model </h4>
            <select id="summary_model">
                <option value="gpt-4o-mini">GPT-4o mini</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="o1-mini">o1-mini</option>
                <option value="o1-preview">o1</option>
              </select>
             <br>
             <h4> Annotation Model </h4>
            <select id="annotation_model">
                <option value="gpt-4o-mini">GPT-4o mini</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="o1-mini">o1-mini</option>
                <option value="o1-preview">o1</option>
              </select>
            <br>
            <button id="annotate-button">Run Annotation</button>
            <h2>Output Files</h2>
            <ul id="file-list"> </ul>
        </div>

      <!-- Right Column -->
        <div class="column-right">
            <div id="readme-content">
                <h2>README</h2>
                <p>
                    Welcome to the file editor. Here you can gather and annotate project data. 
                    Use the sidebar to run the gather and annotation functions, and view the output files.
                </p>
                <p>
                    Click the toggle link above to start editing a file.
                </p>
            </div>
            <!-- Textarea for text file editing -->
            <textarea id="file-content" style="display:none;"></textarea>
            <button id="save-button" style="display:none;">Save</button>
            <table id = "csv-table" class = "cell-border nowrap stripe hover" style="width:100%; height:80%; display:none"> 
            </table>    
        </div>
    </div>

    <script>
        $('#toggle-readme').click(function(e) {
            e.preventDefault();  // Prevent default link behavior
            // Toggle visibility between README and file content
            $('#readme-content').show();  
            $('#file-content').hide();
            $('#save-button').hide();
            $('#csv-table_wrapper').hide();
        });
        // Function to load the list of files
        function loadFiles() {
            $.getJSON('/files', function(files) {
                let fileList = $('#file-list');
                fileList.empty();  // Clear the list
                files.forEach(function(file) {
                    fileList.append(`<li><a href="#" onclick="loadFile('${file}')">${file}</a></li>`);
                });
            });
        }

        // Function to load a file's content
        function loadFile(filename) {
            let fileExtension = filename.split('.').pop().toLowerCase();
    
            // Load file content and determine how to display it based on file type
            $.get(`/file/${filename}`, function(data) {
                if (fileExtension === 'txt') {
                    // Show the text area for text files
                    $('#file-content').show().val(data.content);
                    $('#csv-table_wrapper').hide();
                    $('#csv-table').hide();  // Hide the CSV table if it was displayed
                    $('#readme-content').hide();  // Hide the README if it was displayed
                    $('#save-button').show();  // Show save button for text files
                    $('#save-button').data('filename', filename);  // Save the filename for saving
                } else if (fileExtension === 'csv') {
                    // Hide the text area and display a CSV table for CSV files
                    $('#file-content').hide();
                    $('#readme-content').hide();  // Hide the README if it was displayed
                    $('#csv-table_wrapper').show();
                                // Check if a DataTable is already initialized and destroy it before reinitializing
                    if ($.fn.DataTable.isDataTable('#csv-table')) {
                        $('#csv-table').DataTable().destroy();  // Destroy the old DataTable instance
                        $('#csv-table').empty();  // Clear the table content
                    }
                    $('#csv-table').show().dataTable({
                        data: data.content,
                        columns: data.columns,
                        destroy: true,
                        lengthChange: true,
                        paging: false,
                        scrollResize: false,
                        scrollX: true,
                        scrollY: '50vh',
                        scrollCollapse: true,
                        searching: true,
                        search: {
                            regex: true,
                            caseInsensitive: true,
                            smart: true
                        }
                    });
                    $('#save-button').hide();  // Hide save button for CSV files (if you donâ€™t need to edit them)
    
                } else {
                    alert('Unsupported file type');
                }
            });
        }
    
        // Function to save the file (only for text files)
        $('#save-button').click(function() {
            let filename = $(this).data('filename');
            let content = $('#file-content').val();
            $.ajax({
                url: `/file/edit/${filename}`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ content: content }),
                success: function(response) {
                    alert('File saved successfully!');
                }
            });
        });
    
        // Run gather function on button click
        $('#gather-button').click(function() {
            let projectId = $('#project_id').val();
            if (projectId) {
                $.ajax({
                    url: '/gather',  // Make sure the /gather route exists in your Flask app
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ project_id: projectId }),
                    success: function(response) {
                        loadFiles();  // Reload the list of files after gather is run
                        alert('Gather run successfully!');
                    },
                    error: function() {
                        alert('An error occurred while running gather.');
                    }
                });
            } else {
                alert('Please enter a Project ID.');
            }
        });
   
        $('#annotate-button').click(function() {
             // Get the filtered rows (visible rows after filtering)
            table = $('#csv-table').DataTable();
            let filtered_data = table.rows({ search: 'applied' }).data().toArray();
            let col_names = table.columns().header().toArray().map(x => x.innerText);
                        // Convert the filtered data to an array or JSON format (if needed)
            let summary_model = $('#summary_model').val();
            let annotation_model = $('#annotation_model').val();
            $.ajax({
                url: '/annotate',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ data: filtered_data, 
                                       columns: col_names,
                                       summary_model: summary_model,
                                       annotation_model: annotation_model}),
                success: function(response) {
                    alert('Annotation successful!');
                },
                error: function() {
                    alert('An error occurred while annotating.');
                }
            });
        
        })        

        // Load files on page load
        $(document).ready(function() {
            loadFiles();
        });
    </script>
     

</body>
</html>